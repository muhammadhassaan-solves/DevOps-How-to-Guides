1. Create IAM Policy for Fluent Bit
fluentbit-cloudwatch.json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:DescribeLogStreams",
        "logs:PutLogEvents",
        "logs:PutRetentionPolicy"
      ],
      "Resource": "*"
    }
  ]
}

aws iam create-policy \
  --policy-name FluentBitCloudWatchPolicy \
  --policy-document file://fluentbit-cloudwatch.json

2. Create an IAM Service Account in EKS
eksctl create iamserviceaccount \
  --name fluent-bit \
  --namespace amazon-cloudwatch \
  --cluster alterna-production \
  --attach-policy-arn arn:aws:iam::<ACCOUNT-ID>:policy/FluentBitCloudWatchPolicy \
  --approve \
  --override-existing-serviceaccounts

3. Create CloudWatch Namespace in Kubernetes
kubectl apply -f https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/cloudwatch-namespace.yaml

4. Create Fluent Bit Cluster ConfigMap
CLUSTER_NAME=<your-cluster-name>
REGION=<your-aws-region>

kubectl create configmap fluent-bit-cluster-info \
  --from-literal=cluster.name=${CLUSTER_NAME} \
  --from-literal=logs.region=${REGION} \
  --from-literal=http.server="On" \
  --from-literal=http.port="2020" \
  --from-literal=read.head="Off" \
  --from-literal=read.tail="On" \
  -n amazon-cloudwatch

5. Deploy Fluent Bit DaemonSet
https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/fluent-bit/fluent-bit.yaml

6. Verify Pods
kubectl get pods -n amazon-cloudwatch

7. Set CloudWatch Log Retention
aws logs describe-log-groups --region <region> \
  | jq -r '.logGroups[].logGroupName' \
  | grep -i <keyword> \
  | while read lg; do
      echo "Setting retention for $lg";
      aws logs put-retention-policy \
        --log-group-name "$lg" \
        --retention-in-days 90 \
        --region me-central-1;
    done

8. Enable Cluster Logging (Optional)
eksctl utils update-cluster-logging \
  --cluster=<cluster-name> \
  --region=<region> \
  --approve
