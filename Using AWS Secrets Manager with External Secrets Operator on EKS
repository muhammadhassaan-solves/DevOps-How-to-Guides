1. Create a Secret in AWS Secrets Manager
aws secretsmanager create-secret \
  --name mongodb/prod \
  --description "MongoDB connection string for prod" \
  --secret-string '{"MONGODB_URI":"<mongodbstring>"}' \
  --region <AWS_REGION>

2. Create an IAM Policy to Allow Read Access to the Secret
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowReadMongoSecret",
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue",
        "secretsmanager:DescribeSecret"
      ],
      "Resource": "<SECRET_ARN>"
    }
  ]
}

aws iam create-policy \
  --policy-name EKSReadMongoSecretPolicy-prod \
  --policy-document file://secretsmanager-mongo-policy.json

3. Create an IAM Service Account in EKS
eksctl create iamserviceaccount \
  --name eks-external-secrets-account \
  --namespace external-secrets \
  --cluster <cluster-name> \
  --attach-policy-arn arn:aws:iam::<account-name>:policy/EKSReadMongoSecretPolicy-prod \
  --approve

4. Install External Secrets Operator via Helm
kubectl create ns external-secrets

helm repo add external-secrets https://charts.external-secrets.io
helm repo update

helm install external-secrets external-secrets/external-secrets \
  -n external-secrets \
  --set installCRDs=true

5. Create a ClusterSecretStore
apiVersion: external-secrets.io/v1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager
spec:
  provider:
    aws:
      service: SecretsManager
      region: <region-name>
      auth:
        jwt:
          serviceAccountRef:
            name: eks-external-secrets-account
            namespace: external-secrets

6. Create an ExternalSecret
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: mongodb-connection
  namespace: app
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: mongodb-connection
    creationPolicy: Owner
  data:
    - secretKey: uri
      remoteRef:
        key: mongodb/prod
        property: MONGO_STRING

7. Inject Secret into Pod Environment
env:
  - name: MONGO_STRING
    valueFrom:
      secretKeyRef:
        name: mongodb-connection
        key: uri

Helpful resource:
https://www.youtube.com/watch?v=EonWeoFPpvM
